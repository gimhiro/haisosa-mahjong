# カン新ドラ追加実装

## 作業計画:

1. 麻雀のカンルールにおけるドラ追加仕様の確認
2. 現在のドラ管理システムの調査
3. カン時の新ドラ追加機能の実装
4. UIでの新ドラ表示の実装
5. テストコードの作成
6. 動作確認とデバッグ

## 設計思想:

### カンドラのルール
- 暗カン・明カンを行った際に、新しいドラ表示牌が1枚追加される
- ドラ表示牌は王牌（リンシャン牌）の隣から取得される
- 新ドラは即座に有効になり、その時点から得点計算に影響する
- カン4回まで可能なため、最大でドラ表示牌は5枚になる（初期ドラ1枚+カンドラ4枚）

### 技術的設計
1. **ドラ管理の拡張**:
   - 現在のdoraIndicators配列を動的に拡張可能にする
   - カン時にドラ表示牌を1枚追加する機能を実装

2. **ゲーム状態管理**:
   - GameManagerクラスでカン時のドラ追加処理を実装
   - 王牌からドラ表示牌を取得する機能を追加

3. **UI表示**:
   - PlayerAreaコンポーネントでドラ表示を動的に更新
   - 複数ドラ表示牌に対応したレイアウト調整

4. **得点計算**:
   - scoring.tsでカンドラを含む得点計算に対応

### 実装アプローチ
- TDD（テスト駆動開発）に従い、まずテストケースを作成
- 段階的実装：基本機能→UI表示→統合テスト
- 既存のカン機能との整合性を重視

## 作業対象ファイル:

### ファイル名: src/utils/game-manager.ts
- 改修内容: 
  - addKanDoraIndicator()メソッドを追加
  - カン時に王牌から新しいドラ表示牌を取得してdoraIndicators配列に追加
  - 最大5枚までのドラ制限を実装
  - コンソールログでカンドラ追加を確認

### ファイル名: src/views/FourPlayerGameView.vue  
- 改修内容:
  - declareAnkan()関数にカンドラ追加処理を実装
  - declareKan()関数にカンドラ追加処理を実装
  - 暗カン・明カン両方でカンドラが追加されるように修正

### ファイル名: test/kan_dora_test.py
- 改修内容: 
  - カン新ドラ追加機能の自動テストスクリプトを作成
  - 初期ドラ数とカン後ドラ数を比較する検証ロジック
  - 成功した手牌パターン（1m×4含む）を使用
  - ドラ表示要素の正確な検出機能

## 実装結果:
- ✅ 暗カン実行時に新ドラ表示牌が正常に追加される
- ✅ 明カン実行時にも新ドラ表示牌が追加される  
- ✅ UIでドラ表示が即座に更新される
- ✅ テストで機能が正常に動作することを確認
- ✅ 最大5枚までのドラ制限が実装されている

## 動作確認:
- 初期ドラ表示数: 1個
- カン後ドラ表示数: 2個
- コンソールログ: 「カンドラ追加: sou7」
- テスト結果: 成功

## 裏ドラ機能追加:

### ファイル名: src/utils/game-manager.ts
- 改修内容:
  - getUradoraIndicators()メソッドを追加
  - リーチ時に表ドラ数と同数の裏ドラ表示牌を取得
  - 山の後方から順次取得する仕組みを実装

### ファイル名: src/views/FourPlayerGameView.vue
- 改修内容:
  - 全ての裏ドラ取得箇所でgetUradoraIndicators()を使用するように修正
  - リーチ時の裏ドラが表ドラと同数になるように統一

### ファイル名: test/uradora_test.py
- 改修内容:
  - カン→リーチ→ツモ上がりのシナリオで裏ドラ数テスト
  - Win Modal内での裏ドラ表示数確認機能
  - 表ドラ数と裏ドラ数の一致検証

## 裏ドラ機能動作確認:
- カン前: 表ドラ1個 → 裏ドラ1個
- カン後: 表ドラ2個 → 裏ドラ2個
- Win Modal内での裏ドラ表示: 正常
- テスト結果: 成功