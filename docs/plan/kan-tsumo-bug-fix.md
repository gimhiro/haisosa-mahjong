# カン後のツモ処理バグ修正

## 作業計画:
1. 現在のカン処理実装を調査してバグ箇所を特定
2. カン後に1枚ツモする処理が抜けている箇所を修正
3. 4枚同じ牌を持つテストモックデータでカンテストケースを作成
4. 修正内容の動作確認とテスト実行

## 設計思想:
- カンをした場合は必ず1枚ツモして手牌枚数を維持する
- 暗カン・明カンどちらの場合も適切にツモ処理を実行
- 既存のツモ処理ロジックを活用して一貫性を保つ
- テストモック機能を活用してカンが発生する状況を再現可能にする

## 作業対象ファイル:
- ファイル名: src/views/FourPlayerGameView.vue
- 改修内容: 
  - 暗カン用の状態変数(canAnkan, ankanOptions)を追加
  - 暗カンボタンをUIに追加
  - checkAnkanOptions()関数で手牌で4枚同じ牌をチェック
  - declareAnkan()関数で暗カン実行とツモ処理
  - 人間プレイヤーのターン開始時に暗カンチェックを追加
  - テストモード適用後にも暗カンチェックを追加

- ファイル名: test/kan_test.py
- 改修内容: 暗カンテスト用の自動テストスクリプトを作成

- ファイル名: test/kan_test_working.py
- 改修内容: 包括的なカン機能テストスクリプトを作成

## 実装詳細:

### 暗カン機能の追加
1. 状態変数の追加:
   - canAnkan: 暗カン可能かのフラグ
   - ankanOptions: 暗カン可能な牌の情報

2. UIコンポーネント:
   - 暗カンボタンをアクションエリアに追加
   - orange色で明カンと区別

3. 暗カン判定ロジック:
   - 手牌をグループ化して4枚同じ牌を検出
   - Mapを使用して効率的なチェック

4. 暗カン実行処理:
   - 4枚の牌を手牌から削除
   - 鳴き牌にカンを追加(fromPlayer: 0)
   - drawTileAndKeepSeparate()で嶺上牌をツモ
   - ターンを維持して続けて打牌可能

5. タイミングの改善:
   - 人間プレイヤーのターン開始時に自動チェック
   - ゲーム開始時、テストモード適用時にもチェック

### バグ修正の要点
- 既存の明カン処理はdrawTileAndKeepSeparate()が正常に動作していることを確認
- 暗カンでも同じツモ処理を使用して一貫性を保持
- カン後の手牌枚数が正しく維持されることをテストで確認

### 正しいカンルールの実装
**修正前の問題**:
- カンの正しいルールが実装されていなかった
- 手牌枚数の管理が不正確だった

**修正後の正しいカンルール**:
1. カンは4枚セットで3枚として数える（実質1枚減る）
2. カン宣言前にツモ牌を手牌に加える
3. その後嶺上牌を1枚ツモする
4. 結果として手牌枚数は変わらない

**実装の詳細**:
- declareAnkan()関数でcurrentDrawnTileを手牌に加えてからカン実行
- checkAnkanOptions()関数でツモ牌も含めて4枚同じ牌をチェック
- drawTileAndKeepSeparate()で嶺上牌を確実にツモ
- カンのルールテスト用スクリプト(kan_rule_test.py)を作成

### 追加修正内容

**カン後の手牌ソート機能追加**:
- declareAnkan()関数でカン後にgameManager.value.sortPlayerHand()を呼び出し
- declareKan()関数（明カン）でも同様にソートを追加
- 手牌が整理されて見やすくなる

**手牌数判定ロジックの修正**:
- カン後のターン進行時にツモが行われないバグを修正
- meldTileCount計算でカンを正しく3枚として数えるように修正
- 修正箇所:
  - FourPlayerGameView.vue: currentPlayerIndexのwatcher内の手牌数チェック
  - FourPlayerGameView.vue: getShanten関数内の手牌数チェック
  - game-manager.ts: drawTileAndKeepSeparate関数内の手牌数チェック

**テストスクリプトの追加**:
- kan_turn_test.py: カン後のターン進行とソートのテスト
- カン後の手牌ソートの動作確認
- ターン進行時のツモ処理の正常性確認

### 最終的なカンの動作
1. ツモ牌を手牌に加える
2. 4枚同じ牌を手牌から除去
3. カンを鳴き牌に追加（3枚として数える）
4. 嶺上牌をツモ
5. 手牌をソート
6. ターン継続、次のターンで正常にツモ可能

### 暗カン後のリーチバグ修正

**問題**: 暗カン後にメンゼンでリーチ可能な状態でもリーチボタンが表示されない

**原因**: GameManager.canPlayerRiichi()でメンゼン判定が欠けていた

**修正内容**:
- game-manager.tsのcanPlayerRiichi()関数にメンゼン判定を追加
- 暗カン（fromPlayer === playerIndex）はメンゼンを維持
- 明カン・ポン・チー（fromPlayer !== playerIndex）はメンゼンを破る
- メンゼンでない場合はリーチ不可

**テストスクリプト**:
- ankan_riichi_test.py: 暗カン後のリーチボタン表示テスト
- 暗カン実行→打牌→リーチボタン表示確認のフローをテスト

**麻雀ルール**:
- 暗カン: 自分の手牌4枚でカン、メンゼン維持、リーチ可能
- 明カン: 他人の捨て牌+手牌3枚でカン、メンゼン破られる、リーチ不可

### 暗カン後のリーチ・ツモ上がりバグ修正

**問題**: 暗カン後のリーチ・ツモ上がりで以下の問題が発生
1. リーチボタンが表示されない
2. ツモボタンが表示されない  
3. 四暗刻が「トイトイ三暗刻」として判定される

**根本原因分析**:
1. **リーチ判定**: game-manager.tsのcanPlayerRiichi()で実効手牌サイズ計算が間違っていた
2. **Vue表示条件**: FourPlayerGameView.vueのリーチボタン表示条件が厳格すぎた
3. **四暗刻判定**: scoring.tsで暗カンが常に明カン(isOpen=true)として処理されていた

**修正内容**:

- **ファイル名**: src/utils/game-manager.ts
- **改修内容**: 
  - canPlayerRiichi()関数の実効手牌サイズ計算を修正
  - ツモ牌を考慮した14枚での判定に変更
  - 修正前: `effectiveHandSize === 13`
  - 修正後: `effectiveHandSizeWithTsumo === 14`

- **ファイル名**: src/views/FourPlayerGameView.vue  
- **改修内容**:
  - リーチボタン表示条件から不要な`effectiveHandSize === 13`チェックを削除
  - canPlayerRiichi()の判定結果を信頼する方式に変更

- **ファイル名**: src/utils/scoring.ts
- **改修内容**:
  - 暗カン判定ロジックを修正
  - 修正前: `const isOpen = true` (常に明カン扱い)
  - 修正後: `const isOpen = !(meld.type === 'kan' && meld.fromPlayer === 0)` (暗カン判定)
  - yakuId処理で文字列と数値の両方に対応

- **ファイル名**: test/kan_test.py
- **改修内容**: 
  - 暗カン→リーチ→ツモ上がり→次の局への完全フローテストを実装
  - リーチ後の手動打牌を削除（自動打牌されるため）
  - 詳細な手牌ログとボタン状態確認機能を追加

**動作確認結果**:
- 暗カン後のリーチボタン表示: ✅ 正常
- ツモボタン表示: ✅ 正常  
- 四暗刻単騎判定: ✅ 正常 (yakuId=4, 13翻)
- Win Modal表示: ✅ 正常
- 完全フローテスト: ✅ 成功

**修正のポイント**:
1. カン処理の一貫性確保: game-manager.tsとscoring.tsで手牌枚数計算を統一
2. 暗カン判定の正確化: fromPlayer=0を基準とした判定ロジック
3. Vue反応性の改善: 不要な条件を削除してcanPlayerRiichi()の結果を信頼

### カン・メルド表示機能の実装

**実装内容**: カン表示の改善とWin Modalでのメルド表示追加

**表示ルール**:
- 暗槓: 1枚目と4枚目を裏向き表示
- 明槓: 鳴いた方向に応じて横向き表示
  - 右からのミンカン: 4枚目を横向き
  - 上からのミンカン: 3枚目を横向き
  - 左からのミンカン: 1枚目を横向き
- ポン: 鳴いた牌を横向き表示
- チー: 鳴いた牌を横向き表示

**修正ファイル**:

- **ファイル名**: src/components/PlayerArea.vue
- **改修内容**:
  - shouldTileBeYoko()関数を修正してカンの横向き表示ルールを実装
  - shouldTileBeBack()関数を新規追加して暗槓の裏向き表示を実装
  - MahjongTileコンポーネントにis-back属性を追加

- **ファイル名**: src/components/MahjongTile.vue
- **改修内容**:
  - 裏向き表示用のテンプレート構造を追加（tile-back要素）
  - isBackプロパティ対応の実装
  - 既存のtile-backスタイルに合わせた裏向きCSS実装
  - tile-backクラスをtileClassesに追加

- **ファイル名**: src/components/WinModal.vue
- **改修内容**:
  - メルドセクションをWin Modalに追加
  - shouldTileBeYoko()とshouldTileBeBack()関数を実装
  - メルド表示用CSS（melds-section, melds-display, meld-group）を追加
  - Meld型のインポート追加

- **ファイル名**: test/meld_view_test.py
- **改修内容**: 
  - メルド表示の包括的テストスクリプトを作成
  - 暗槓→リーチ→ツモ→Win Modal表示の完全フローテスト
  - メルド表示のスクリーンショット撮影機能

- **ファイル名**: test/all_meld_test.py
- **改修内容**:
  - 詳細なメルド表示分析テストスクリプト
  - タイル属性の詳細確認機能
  - 暗槓の裏向き表示確認機能

**動作確認結果**:
- 暗槓の裏向き表示: ✅ 正常（1枚目と4枚目が裏向き）
- 明槓の横向き表示: ✅ 正常（方向別に適切な位置が横向き）
- Win Modalでのメルド表示: ✅ 正常
- メルド表示テスト: ✅ 成功

**実装の特徴**:
1. 既存のtile-backスタイルとの統一性確保
2. PlayerArea.vueとWinModal.vueで共通のメルド表示ロジック
3. CSS-onlyでの裏向き表示実装（画像ファイル不要）
4. 包括的なテストスクリプトによる動作確認